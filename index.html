<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sam Pack Admin V7.1 (Super Parser)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>

    <style>
        :root { --primary: #2c3e50; --accent: #ffc107; --bg: #f8f9fa; }
        body { background: var(--bg); font-family: 'Segoe UI', sans-serif; padding-bottom: 80px; }

        .sidebar { width: 260px; height: 100vh; position: fixed; top: 0; left: 0; background: var(--primary); color: white; transition: 0.3s; z-index: 1000; overflow-y: auto; }
        .main-content { margin-left: 260px; padding: 20px; transition: 0.3s; }
        .nav-btn { padding: 15px; cursor: pointer; display: flex; align-items: center; gap: 10px; color: #adb5bd; transition: 0.2s; border-radius: 0 25px 25px 0; margin-bottom: 5px; }
        .nav-btn:hover, .nav-btn.active { background: rgba(255,255,255,0.1); color: var(--accent); border-left: 4px solid var(--accent); }

        .mobile-header { display: none; background: var(--primary); color: white; padding: 15px; position: sticky; top:0; z-index: 999; justify-content: space-between; align-items: center; }
        .mobile-bottom-nav { display: none; position: fixed; bottom: 0; width: 100%; background: white; border-top: 1px solid #ddd; padding: 10px 0; z-index: 1000; justify-content: space-around; }
        .mob-icon { text-align: center; color: #999; font-size: 0.8rem; }
        .mob-icon.active { color: var(--primary); }

        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .main-content { margin-left: 0; padding: 15px; }
            .mobile-header { display: flex; }
            .mobile-bottom-nav { display: flex; }
            .desktop-only { display: none !important; }
        }

        .card-box { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); margin-bottom: 20px; }
        .drop-zone { border: 3px dashed #cbd5e1; border-radius: 15px; padding: 40px; text-align: center; background: #fff; cursor: pointer; transition: 0.3s; }
        .drop-zone:hover { border-color: var(--accent); background: #fffdf5; }
        
        .badge-status { padding: 5px 10px; border-radius: 8px; font-size: 0.85em; }
        .st-open { background: #e9ecef; color: #495057; }
        .st-packed { background: #cff4fc; color: #055160; }
        .st-done { background: #d1e7dd; color: #0f5132; }

        #imgModalContent { width: 100%; height: auto; border-radius: 8px; }
    </style>
</head>
<body>

<div class="mobile-header">
    <h5 class="m-0 fw-bold"><i class="fa-solid fa-cube text-warning"></i> Sam Pack</h5>
    <button class="btn btn-sm btn-outline-warning" onclick="location.reload()"><i class="fa fa-sync"></i></button>
</div>

<div class="sidebar">
    <div class="p-4 text-center"><h3 class="fw-bold">SAM PACK</h3><small class="text-white-50">Admin V7.1</small></div>
    <div class="nav-btn active" onclick="nav('dash')" id="d-dash"><i class="fa fa-chart-pie"></i> √úbersicht</div>
    <div class="nav-btn" onclick="nav('import')" id="d-import"><i class="fa fa-cloud-upload"></i> PDF Import</div>
    <div class="nav-btn" onclick="nav('drivers')" id="d-drivers"><i class="fa fa-truck"></i> Fahrer</div>
</div>

<div class="main-content">
    <div id="view-dash">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="fw-bold">üìÖ Tages√ºbersicht</h4>
            <input type="date" id="dashDate" class="form-control w-auto shadow-sm" onchange="renderDash()">
        </div>
        <div class="row g-3 mb-4">
            <div class="col-6 col-md-3"><div class="card-box text-center py-3"><small class="text-muted">Umsatz</small><h3 class="fw-bold text-success mb-0" id="totalCHF">0.00</h3></div></div>
            <div class="col-6 col-md-3"><div class="card-box text-center py-3"><small class="text-muted">Bestellungen</small><h3 class="fw-bold text-primary mb-0" id="totalCount">0</h3></div></div>
        </div>
        <div class="card-box p-0 overflow-hidden">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light"><tr><th>Kunde</th><th>Status</th><th>CHF</th><th class="text-end">Aktion</th></tr></thead>
                    <tbody id="dashTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="view-import" class="d-none">
        <h4 class="fw-bold mb-3">üìÑ Rechnungen hochladen</h4>
        <div class="drop-zone shadow-sm" onclick="document.getElementById('pdfIn').click()">
            <i class="fa fa-file-pdf fa-3x text-danger mb-3"></i>
            <h5>PDFs hier ablegen</h5>
            <p class="text-muted small">Automatische Erkennung (Positionen & Bild)</p>
            <input type="file" id="pdfIn" hidden multiple accept="application/pdf">
        </div>
        <div id="importLog" class="mt-3"></div>
    </div>

    <div id="view-drivers" class="d-none">
        <h4 class="fw-bold mb-3">üöõ Fahrer</h4>
        <div class="card-box">
            <div class="input-group mb-3">
                <input id="drvName" class="form-control" placeholder="Name">
                <input id="drvPin" class="form-control" placeholder="PIN" style="max-width: 80px;">
                <button onclick="addDrv()" class="btn btn-dark">+</button>
            </div>
            <ul id="drvList" class="list-group list-group-flush"></ul>
        </div>
    </div>
</div>

<div class="mobile-bottom-nav">
    <div class="mob-icon active" onclick="nav('dash')" id="m-dash"><i class="fa fa-chart-pie"></i>Dash</div>
    <div class="mob-icon" onclick="nav('import')" id="m-import"><i class="fa fa-cloud-upload"></i>Import</div>
    <div class="mob-icon" onclick="nav('drivers')" id="m-drivers"><i class="fa fa-users"></i>Team</div>
</div>

<div class="modal fade" id="invoiceModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Rechnung</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body text-center bg-dark"><img id="imgModalContent" src="" alt="Lade..."></div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, doc, deleteDoc, onSnapshot, query, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyCY9TmJwzoJRWFTAjhDFBD0eFMR4YKTHJQ", authDomain: "listapp-96713.firebaseapp.com", projectId: "listapp-96713", storageBucket: "listapp-96713.firebasestorage.app", messagingSenderId: "1044312662356", appId: "1:1044312662356:web:64fd48530c4238127828c1" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let gOrders = [];

    window.onload = () => { document.getElementById('dashDate').valueAsDate = new Date(); listenData(); };
    window.nav = (id) => {
        document.querySelectorAll('[id^="view-"]').forEach(e => e.classList.add('d-none'));
        document.getElementById('view-'+id).classList.remove('d-none');
        document.querySelectorAll('.nav-btn, .mob-icon').forEach(e => e.classList.remove('active'));
        if(document.getElementById('d-'+id)) document.getElementById('d-'+id).classList.add('active');
        if(document.getElementById('m-'+id)) document.getElementById('m-'+id).classList.add('active');
        if(id === 'dash') renderDash();
    };

    function listenData() {
        onSnapshot(query(collection(db, "orders"), orderBy("deliveryDate", "desc")), snap => {
            gOrders = []; snap.forEach(d => gOrders.push({id: d.id, ...d.data()})); renderDash();
        });
        onSnapshot(collection(db, "drivers"), snap => {
            const l = document.getElementById('drvList'); l.innerHTML = '';
            snap.forEach(d => l.innerHTML += `<li class="list-group-item d-flex justify-content-between">${d.data().name} <button class="btn btn-sm text-danger" onclick="window.delDrv('${d.id}')">√ó</button></li>`);
        });
    }

    window.renderDash = () => {
        const date = document.getElementById('dashDate').value;
        const list = gOrders.filter(o => o.deliveryDate === date);
        const tbody = document.getElementById('dashTable'); tbody.innerHTML = '';
        let sum = 0;

        if(list.length === 0) { tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-4">Nichts gefunden.</td></tr>'; }
        else {
            list.forEach(o => {
                sum += parseFloat(o.totalAmount || 0);
                let stClass = 'st-open', stText = 'Offen';
                if(o.status === 'Packed') { stClass = 'st-packed'; stText = 'Gepackt'; }
                if(o.status === 'Delivered') { stClass = 'st-done'; stText = 'Geliefert'; }
                
                let imgBtn = o.invoiceImg ? `<button class="btn btn-sm btn-light border me-1" onclick="window.showImg('${o.id}')"><i class="fa fa-eye text-primary"></i></button>` : '';

                // Count items properly
                let itemCount = (o.items && Array.isArray(o.items)) ? o.items.length : 0;
                let itemText = itemCount > 0 ? `<span class="text-success"><i class="fa fa-check"></i> ${itemCount} Pos.</span>` : `<span class="text-danger">Keine Pos.</span>`;

                tbody.innerHTML += `
                <tr>
                    <td><div class="fw-bold">${o.customerName}</div><div class="small text-muted">${o.bexioId || ''} ‚Ä¢ ${itemText}</div></td>
                    <td><span class="badge-status ${stClass}">${stText}</span></td>
                    <td class="fw-bold">${parseFloat(o.totalAmount).toFixed(2)}</td>
                    <td class="text-end">${imgBtn}<button class="btn btn-sm btn-outline-danger" onclick="window.delOrd('${o.id}')"><i class="fa fa-trash"></i></button></td>
                </tr>`;
            });
        }
        document.getElementById('totalCHF').innerText = sum.toFixed(2);
        document.getElementById('totalCount').innerText = list.length;
    };

    // --- IMPROVED PDF PARSER V7.1 ---
    document.getElementById('pdfIn').addEventListener('change', async (e) => {
        const files = e.target.files; if(!files.length) return;
        const log = document.getElementById('importLog');
        log.innerHTML = '<div class="alert alert-info">‚è≥ Verarbeitung l√§uft...</div>';
        const batch = writeBatch(db);
        let count = 0;

        for(let file of files) {
            try {
                const imgData = await pdfToImage(file);
                const text = await pdfToText(file);
                const data = parseBexioRobust(text); // NEW PARSER FUNCTION
                
                if(data && data.bexioId) {
                    const ref = doc(collection(db, "orders"));
                    batch.set(ref, { ...data, invoiceImg: imgData });
                    count++;
                }
            } catch(err) { console.error(err); }
        }

        if(count > 0) { await batch.commit(); log.innerHTML = `<div class="alert alert-success">‚úÖ ${count} Rechnungen importiert!</div>`; setTimeout(() => nav('dash'), 1500); }
        else { log.innerHTML = `<div class="alert alert-warning">‚ùå Fehler: Daten nicht erkannt.</div>`; }
    });

    async function pdfToImage(file) {
        const buffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(buffer).promise;
        const page = await pdf.getPage(1);
        const viewport = page.getViewport({ scale: 1.0 });
        const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
        canvas.height = viewport.height; canvas.width = viewport.width;
        await page.render({canvasContext: ctx, viewport: viewport}).promise;
        return canvas.toDataURL('image/jpeg', 0.7);
    }

    async function pdfToText(file) {
        const buffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(buffer).promise;
        const page = await pdf.getPage(1);
        const textContent = await page.getTextContent();
        return textContent.items.map(i => i.str).join(' | ');
    }

    // --- THE FIX: ROBUST PARSER ---
    function parseBexioRobust(text) {
        // Clean up common Swiss number formats (1'200.00 -> 1200.00) just for parsing logic
        // But we keep original text for regex matching to be safe
        
        const idMatch = text.match(/Rechnung\s+(RE-\d+)/);
        const dateMatch = text.match(/Datum:\s*\|\s*(\d{2}\.\d{2}\.\d{4})/);
        const customerMatch = text.split('|')[0].trim();
        
        // Try to find Total Amount (handling ' separator)
        // Regex looks for: Betrag inkl. MWST | 1'015.40
        const totalMatch = text.match(/Betrag inkl\. MWST\s*\|\s*([\d\.'‚Äô]+)/);

        if(!idMatch) return null;

        let dateISO = new Date().toISOString().split('T')[0];
        if(dateMatch) { const [d, m, y] = dateMatch[1].split('.'); dateISO = `${y}-${m}-${d}`; }

        const items = [];
        // Updated Regex to match: Number | Text | Qty Unit | Price | Total
        // Matches: 1 | 001 /Pommes... | 180 kg | 3.40 | 612.00
        // It allows spaces, dots, and characters in the description
        const itemRegex = /(\d+)\s*\|\s*([\s\S]*?)\s*\|\s*([\d\.]+(?:\s*[a-zA-Z√§√∂√º√Ñ√ñ√ú%]+)?)\s*\|\s*([\d\.]+)\s*\|\s*([\d\.'‚Äô]+)/g;
        
        let match;
        while ((match = itemRegex.exec(text)) !== null) {
            // Filter: Description usually longer than 2 chars, and row shouldn't contain "Total" in description
            if(match[2].length > 2 && !match[2].includes('Total') && !match[2].includes('Rechnung')) {
                items.push({
                    name: match[2].trim(),
                    qty: match[3].trim(),
                    price: parseFloat(match[4].replace(/['‚Äô]/g, '')), // Remove ' from price
                    total: parseFloat(match[5].replace(/['‚Äô]/g, ''))  // Remove ' from total
                });
            }
        }

        return {
            bexioId: idMatch[1],
            customerName: customerMatch || "Unbekannt",
            deliveryDate: dateISO,
            totalAmount: totalMatch ? parseFloat(totalMatch[1].replace(/['‚Äô]/g, '')) : 0,
            status: 'Open',
            items: items,
            createdAt: new Date().toISOString()
        };
    }

    window.showImg = (id) => { const o = gOrders.find(x => x.id === id); if(o && o.invoiceImg) { document.getElementById('imgModalContent').src = o.invoiceImg; new bootstrap.Modal(document.getElementById('invoiceModal')).show(); } };
    window.addDrv = async () => { const n=document.getElementById('drvName').value; const p=document.getElementById('drvPin').value; if(n&&p) await addDoc(collection(db,"drivers"),{name:n,pin:p}); };
    window.delDrv = async (id) => deleteDoc(doc(db,"drivers",id));
    window.delOrd = async (id) => { if(confirm("L√∂schen?")) deleteDoc(doc(db,"orders",id)); };
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
